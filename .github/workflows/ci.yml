name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    name: ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: pnpmã‚¹ãƒˆã‚¢ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å–å¾—
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package.json', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
        run: pnpm lint

      - name: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        run: |
          pnpm exec turbo run lint:format
          pnpm run format:package --check

      - name: å‹ãƒã‚§ãƒƒã‚¯
        run: pnpm type-check

      - name: ãƒ“ãƒ«ãƒ‰
        run: pnpm build

      - name: ãƒ“ãƒ«ãƒ‰çµæœåˆ†æï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        id: build-analysis
        run: bash .github/scripts/build-analysis.sh

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å®Ÿè¡Œ
        if: github.event_name == 'pull_request'
        id: audit
        run: bash .github/scripts/audit.sh

      - name: å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸èª¿æŸ»å®Ÿè¡Œ
        if: github.event_name == 'pull_request'
        id: outdated
        run: bash .github/scripts/outdated.sh

      - name: ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        run: cd apps/app && ANALYZE=true pnpm vite build

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®Artifactsã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        id: upload-artifacts
        with:
          name: build-artifacts-${{ github.event.pull_request.number }}
          path: apps/app/dist/
          retention-days: 14

      - name: ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®Artifactsã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-report-${{ github.event.pull_request.number }}
          path: apps/app/bundle-report.html
          retention-days: 14

      - name: PRã«Artifactsãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸš€ ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            PR #${{ github.event.pull_request.number }} ã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒæº–å‚™ã§ãã¾ã—ãŸï¼

            **ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ğŸ‘‰** [GitHub Actionsã®å®Ÿè¡Œãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <details>
            <summary>ğŸ“¦ Artifactsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            - **ãƒ“ãƒ«ãƒ‰æˆæœç‰©**: `build-artifacts-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: apps/appã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆHTMLã€CSSã€JavaScriptï¼‰
            - **ğŸ“Š Vitestãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: `vitest-html-report-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: Vitestãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆ
            - **ğŸ“ˆ ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆ**: `bundle-analysis-report-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: JavaScriptãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®è©³ç´°åˆ†æï¼ˆrollup-plugin-visualizerï¼‰
            - **ğŸ“š TypeDoc APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: `typedoc-api-docs-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: TSDocã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆTypeDocï¼‰
            - **ğŸ­ Playwrightãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: `playwright-html-report-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰ã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆ
            - **ä¿å­˜æœŸé–“**: 14æ—¥é–“

            **ğŸ“‹ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ‰‹é †ï¼š**
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Actionså®Ÿè¡Œãƒšãƒ¼ã‚¸ã‚’é–‹ã
            2. ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ã€ŒArtifactsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
            3. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

            **ğŸ“Š ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦ï¼š**
            - **Vitestãƒ¬ãƒãƒ¼ãƒˆ**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œçµæœã€ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã€å®Ÿè¡Œæ™‚é–“ã€å¤±æ•—è©³ç´°
            - **Playwrightãƒ¬ãƒãƒ¼ãƒˆ**: E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œçµæœã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€å®Ÿè¡Œãƒ­ã‚°ã€å„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®çµæœ

            **ğŸ“ˆ ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦ï¼š**
            ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆã«ã¯ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
            - JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®è©³ç´°åˆ†æ
            - ä¾å­˜é–¢ä¿‚ã®ã‚µã‚¤ã‚ºå†…è¨³ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ¥ï¼‰
            - ãƒ„ãƒªãƒ¼ãƒãƒƒãƒ—ã«ã‚ˆã‚‹è¦–è¦šçš„ãªã‚µã‚¤ã‚ºè¡¨ç¤º
            - gzipãƒ»brotliåœ§ç¸®ã‚µã‚¤ã‚ºã®æ¯”è¼ƒ

            **ğŸ“š TypeDoc APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦ï¼š**
            TypeDoc APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ä»¥ä¸‹ã®æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š
            - TypeScriptã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
            - TSDocã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸé–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»å‹ã®èª¬æ˜
            - ä½¿ç”¨ä¾‹ã¨ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«
            - å‹æƒ…å ±ã¨ç¶™æ‰¿é–¢ä¿‚ã®è©³ç´°

            </details>

            ## ğŸ“Š ãƒ“ãƒ«ãƒ‰çµæœã‚µãƒãƒªãƒ¼

            **ğŸ“¦ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«çµ±è¨ˆ**
            - **ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${{ steps.build-analysis.outputs.total_files }}ä»¶
            - **ç·ã‚µã‚¤ã‚º**: ${{ steps.build-analysis.outputs.total_size_formatted }}
            - **æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.build-analysis.outputs.max_file }} (${{ steps.build-analysis.outputs.max_size_formatted }})

            **ğŸ“‹ æ‹¡å¼µå­åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«æ•°**
            ${{ steps.build-analysis.outputs.ext_counts }}

            <details>
            <summary>ğŸ“„ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°ä¸€è¦§ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            | ãƒ•ã‚¡ã‚¤ãƒ«å | ã‚µã‚¤ã‚º | ãƒ‘ã‚¹ |
            |-----------|----------------|------|
            ${{ steps.build-analysis.outputs.files_table }}

            </details>

            ---
            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã«ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã€ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã€ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ã”ç¢ºèªãã ã•ã„ã€‚*

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœã‚’è§£æãƒ»æº–å‚™
        if: github.event_name == 'pull_request'
        id: parse-audit
        env:
          AUDIT_RESULT: ${{ steps.audit.outputs.audit_result }}
        run: bash .github/scripts/parse-audit.sh

      - name: å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸çµæœã‚’è§£æãƒ»æº–å‚™
        if: github.event_name == 'pull_request'
        id: parse-outdated
        env:
          OUTDATED_RESULT: ${{ steps.outdated.outputs.outdated_result }}
        run: bash .github/scripts/parse-outdated.sh

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ”’ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ» & ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°çŠ¶æ³

            PR #${{ github.event.pull_request.number }} ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã¨ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°çŠ¶æ³ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸï¼

            ### ğŸ“Š ç›£æŸ»ã‚µãƒãƒªãƒ¼
            **ğŸ“¦ èª¿æŸ»å¯¾è±¡**: ${{ steps.parse-audit.outputs.total_deps }}ä»¶ã®ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
            **ğŸš¨ æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§**: ${{ steps.parse-audit.outputs.total_vulns }}ä»¶

            ### ğŸ“‹ è„†å¼±æ€§ãƒ¬ãƒ™ãƒ«åˆ¥è©³ç´°
            - ğŸ”´ **Critical**: ${{ steps.parse-audit.outputs.critical }}ä»¶
            - ğŸŸ  **High**: ${{ steps.parse-audit.outputs.high }}ä»¶  
            - ğŸŸ¡ **Moderate**: ${{ steps.parse-audit.outputs.moderate }}ä»¶
            - ğŸ”µ **Low**: ${{ steps.parse-audit.outputs.low }}ä»¶
            - â„¹ï¸ **Info**: ${{ steps.parse-audit.outputs.info }}ä»¶

            ${{ steps.parse-audit.outputs.total_vulns == '0' && 'âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼** ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å®‰å…¨ã§ã™ã€‚' || 'âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚** è©³ç´°ã¯ä¸‹è¨˜ã‚’ã”ç¢ºèªãã ã•ã„ã€‚' }}

            ### ğŸ“ˆ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°çŠ¶æ³
            **ğŸ”„ å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**: ${{ steps.parse-outdated.outputs.outdated_count }}ä»¶

            ${{ steps.parse-outdated.outputs.outdated_count == '0' && 'âœ… **ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒæœ€æ–°ã§ã™ï¼** æ›´æ–°ãŒå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' || 'ğŸ“¦ **æ›´æ–°å¯èƒ½ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã™ï¼š** ' }}${{ steps.parse-outdated.outputs.outdated_count != '0' && steps.parse-outdated.outputs.outdated_packages || '' }}

            ${{ steps.parse-outdated.outputs.has_outdated == 'true' && '### ğŸ“‹ å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è©³ç´°

            <details>
            <summary>ğŸ“„ è©³ç´°ãªæ›´æ–°æƒ…å ±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            ```json
            ' || '' }}${{ steps.parse-outdated.outputs.has_outdated == 'true' && steps.outdated.outputs.outdated_result || '' }}${{ steps.parse-outdated.outputs.has_outdated == 'true' && '```

            </details>

            ### ğŸ› ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°æ–¹æ³•
            ```bash
            # å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°ç¢ºèª
            pnpm outdated

            # ç‰¹å®šã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°
            pnpm update <package-name>

            # å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å®‰å…¨ã«æ›´æ–°ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ç¯„å›²å†…ï¼‰
            pnpm update
            ```' || '' }}

            ${{ steps.parse-audit.outputs.has_advisories == 'true' && '### ğŸ” æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§ã®è©³ç´°

            <details>
            <summary>ğŸ“„ è©³ç´°ãªAdvisoriesæƒ…å ±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            ```json
            ' || '' }}${{ steps.parse-audit.outputs.has_advisories == 'true' && steps.audit.outputs.audit_result || '' }}${{ steps.parse-audit.outputs.has_advisories == 'true' && '```

            </details>

            ### ğŸ› ï¸ ä¿®å¾©æ–¹æ³•
            ```bash
            # è„†å¼±æ€§ã‚’è‡ªå‹•ä¿®å¾©ã™ã‚‹å ´åˆ
            pnpm audit --fix

            # ç‰¹å®šã®CVEã‚’ç„¡è¦–ã™ã‚‹å ´åˆ
            pnpm audit --ignore <CVE-ID>
            ```' || '' }}

            ### ğŸ’¡ ç›£æŸ»ãƒ»æ›´æ–°ãƒã‚§ãƒƒã‚¯ã«ã¤ã„ã¦
            - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ„ãƒ¼ãƒ«**: pnpm audit
            - **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«**: pnpm outdated
            - **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: npm security advisories, npm registry
            - **å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: PRä½œæˆãƒ»æ›´æ–°æ™‚
            - **å¯¾è±¡**: dependencies, devDependencies, optionalDependenciesï¼ˆå…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ï¼‰

            ---
            *ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚é‡è¦ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯é©åˆ‡ã«å¯¾å‡¦ã—ã€å¤ã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚*

      - name: Vitestãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: pnpm exec turbo run test -- --passWithNoTests

      - name: Vitestãƒ†ã‚¹ãƒˆçµæœã‚’è§£æãƒ»æº–å‚™ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        id: parse-vitest
        run: bash .github/scripts/parse-vitest.sh

      - name: Vitestãƒ†ã‚¹ãƒˆçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request' && steps.parse-vitest.outputs.json_exists == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ§ª Vitestãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼

            PR #${{ github.event.pull_request.number }} ã®Vitestãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼

            ### ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ
            ${{ steps.parse-vitest.outputs.success == 'true' && 'âœ… **å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼**' || 'âŒ **ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™**' }}

            **ğŸ“ˆ ãƒ†ã‚¹ãƒˆçµ±è¨ˆæƒ…å ±:**
            - ğŸ§ª **å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°**: ${{ steps.parse-vitest.outputs.total_tests }}ä»¶
            - âœ… **æˆåŠŸ**: ${{ steps.parse-vitest.outputs.passed_tests }}ä»¶
            - âŒ **å¤±æ•—**: ${{ steps.parse-vitest.outputs.failed_tests }}ä»¶
            - â³ **ä¿ç•™**: ${{ steps.parse-vitest.outputs.pending_tests }}ä»¶
            - ğŸ“ **TODO**: ${{ steps.parse-vitest.outputs.todo_tests }}ä»¶

            **ğŸ“‚ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆæƒ…å ±:**
            - ğŸ“ **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${{ steps.parse-vitest.outputs.total_suites }}ä»¶
            - âœ… **æˆåŠŸãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.parse-vitest.outputs.passed_suites }}ä»¶
            - âŒ **å¤±æ•—ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ steps.parse-vitest.outputs.failed_suites }}ä»¶

            **â±ï¸ å®Ÿè¡Œæ™‚é–“**: ${{ steps.parse-vitest.outputs.duration_sec }}ç§’

            ${{ steps.parse-vitest.outputs.failed_tests != '0' && '### ğŸ” å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°' || '' }}
            ${{ steps.parse-vitest.outputs.failed_test_details }}

            <details>
            <summary>ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>

            **ğŸ“Š è©³ç´°ãªãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã¯ã“ã¡ã‚‰ğŸ‘‰** [GitHub Actionsã®å®Ÿè¡Œãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Artifactsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š**
            - **ğŸ“ˆ VitestHTMLãƒ¬ãƒãƒ¼ãƒˆ**: `vitest-html-report-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆã€ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã€å®Ÿè¡Œæ™‚é–“è©³ç´°

            ### ğŸ’¡ ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦
            - **ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼**: Vitest v3.2.0
            - **ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: V8
            - **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: jsdom
            - **å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: PRä½œæˆãƒ»æ›´æ–°æ™‚

            </details>

            ---
            *ã“ã®ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚*

      - name: Vitestãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: vitest-html-report-${{ github.event.pull_request.number }}
          path: apps/app/test-results/
          retention-days: 14

      - name: TypeDocAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
        run: pnpm typedoc

      - name: TypeDocAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: typedoc-api-docs-${{ github.event.pull_request.number }}
          path: apps/app/docs-api/
          retention-days: 14

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm --filter app exec playwright install --with-deps chromium

      - name: E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: pnpm --filter app test:e2e:chromium

      - name: Playwrightãƒ†ã‚¹ãƒˆçµæœã‚’è§£æãƒ»æº–å‚™ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: always() && github.event_name == 'pull_request'
        id: parse-playwright
        run: bash .github/scripts/parse-playwright.sh

      - name: Playwrightãƒ†ã‚¹ãƒˆçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: always() && github.event_name == 'pull_request' && steps.parse-playwright.outputs.json_exists == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ­ Playwrightãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼

            PR #${{ github.event.pull_request.number }} ã®Playwright E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼

            ### ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ
            ${{ steps.parse-playwright.outputs.overall_success == 'true' && 'âœ… **å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼**' || 'âŒ **ãƒ†ã‚¹ãƒˆã«å¤±æ•—ãŒã‚ã‚Šã¾ã™**' }}

            **ğŸ“ˆ ãƒ†ã‚¹ãƒˆçµ±è¨ˆæƒ…å ±:**
            - ğŸ§ª **å®Ÿè¡Œãƒ†ã‚¹ãƒˆæ•°**: ${{ steps.parse-playwright.outputs.total_tests }}ä»¶
            - âœ… **æˆåŠŸ**: ${{ steps.parse-playwright.outputs.passed_tests }}ä»¶
            - âŒ **å¤±æ•—**: ${{ steps.parse-playwright.outputs.failed_tests }}ä»¶
            - ğŸ”„ **ä¸å®‰å®šï¼ˆFlakyï¼‰**: ${{ steps.parse-playwright.outputs.flaky_tests }}ä»¶
            - â­ï¸ **ã‚¹ã‚­ãƒƒãƒ—**: ${{ steps.parse-playwright.outputs.skipped_tests }}ä»¶
            - ğŸ“Š **æˆåŠŸç‡**: ${{ steps.parse-playwright.outputs.success_rate }}%

            **â±ï¸ å®Ÿè¡Œæ™‚é–“**: ${{ steps.parse-playwright.outputs.duration_sec }}ç§’

            ${{ steps.parse-playwright.outputs.failed_tests != '0' && '### ğŸ” å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®è©³ç´°' || '' }}
            ${{ steps.parse-playwright.outputs.failed_test_details }}

            <details>
            <summary><strong>ğŸ“‚ ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆæƒ…å ±</strong></summary>

            - ğŸ“ **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${{ steps.parse-playwright.outputs.total_suites }}ä»¶
            - ğŸŒ **å®Ÿè¡Œãƒ–ãƒ©ã‚¦ã‚¶**: ${{ steps.parse-playwright.outputs.browser_info }}

            </details>

            <details>
            <summary><strong>ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</strong></summary>

            **ğŸ“Š è©³ç´°ãªãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã¯ã“ã¡ã‚‰ğŸ‘‰** [GitHub Actionsã®å®Ÿè¡Œãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            **Artifactsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š**
            - **ğŸ­ PlaywrightHTMLãƒ¬ãƒãƒ¼ãƒˆ**: `playwright-html-report-${{ github.event.pull_request.number }}`
              - **å†…å®¹**: E2Eãƒ†ã‚¹ãƒˆã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€å®Ÿè¡Œãƒ­ã‚°ã€å„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®çµæœ

            </details>

            <details>
            <summary><strong>ğŸ’¡ E2Eãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦</strong></summary>

            - **ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼**: Playwright
            - **å®Ÿè¡Œãƒ–ãƒ©ã‚¦ã‚¶**: Chromiumï¼ˆCIç’°å¢ƒï¼‰
            - **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: Viteé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ (http://localhost:3000)
            - **å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**: PRä½œæˆãƒ»æ›´æ–°æ™‚
            - **ãƒ†ã‚¹ãƒˆå†…å®¹**: UIæ©Ÿèƒ½ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³

            </details>

            ---
            *ã“ã®ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚*

      - name: Playwrightãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®Artifactsã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆPRæ™‚ã®ã¿ï¼‰
        if: always() && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-report-${{ github.event.pull_request.number }}
          path: apps/app/playwright-report/
          retention-days: 14