name: Release (main)

on:
  push:
    branches: [main]

jobs:
  release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆã¨ã‚¢ã‚»ãƒƒãƒˆæ·»ä»˜
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: pnpmã‚¹ãƒˆã‚¢ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å–å¾—
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: apps/appã®ãƒ“ãƒ«ãƒ‰
        run: pnpm --filter app build

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®åœ§ç¸®
        run: |
          cd apps/app
          zip -r ../../build-artifacts.zip dist/

      - name: GitHub Release ã®ä½œæˆã¨ã‚¢ã‚»ãƒƒãƒˆæ·»ä»˜
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ github.run_number }}
          name: "Build ${{ github.run_number }}"
          artifacts: "build-artifacts.zip"
          generateReleaseNotes: true
          body: |
            ## ğŸš€ Study GitHub Agent - Release Build ${{ github.run_number }}

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆï¼ˆ${{ github.sha }}ï¼‰ã«åŸºã¥ã„ãŸapps/appã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

            ### ğŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            - **build-artifacts.zip**: apps/appã®Vite + Reactãƒ“ãƒ«ãƒ‰æˆæœç‰©
              - index.html
              - CSSã€JavaScriptãƒ•ã‚¡ã‚¤ãƒ«
              - é™çš„ã‚¢ã‚»ãƒƒãƒˆ

            ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è¨˜ã®ã€ŒAssetsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ `build-artifacts.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
            3. Webã‚µãƒ¼ãƒãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦å…¬é–‹

            ### ğŸ”— é–¢é€£æƒ…å ±
            - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **ãƒ–ãƒ©ãƒ³ãƒ**: main
            - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ${{ github.run_started_at }}

            ---
            *ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*