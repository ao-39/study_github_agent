name: Release (main)

on:
  push:
    branches: [main]

# åŒæ™‚å®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆGitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å«ã‚€ãŸã‚ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: ãƒªãƒªãƒ¼ã‚¹ä½œæˆã¨ã‚¢ã‚»ãƒƒãƒˆæ·»ä»˜
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      pages: write
      id-token: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: pnpmã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: pnpmã‚¹ãƒˆã‚¢ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å–å¾—
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Turborepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: apps/appã®ãƒ“ãƒ«ãƒ‰
        run: pnpm --filter app build

      - name: Vitestãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: pnpm exec turbo run test -- --passWithNoTests

      - name: ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: cd apps/app && ANALYZE=true pnpm vite build

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm --filter app exec playwright install --with-deps chromium

      - name: Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: pnpm --filter app test:e2e:chromium
        continue-on-error: true

      - name: Playwrightãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆï¼ˆå¤±æ•—æ™‚å¯¾å¿œï¼‰
        run: |
          cd apps/app
          if [ ! -d "playwright-report" ]; then
            mkdir -p playwright-report
            echo "<html><body><h1>Playwrightãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</h1><p>ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p></body></html>" > playwright-report/index.html
          fi

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®åœ§ç¸®
        run: |
          cd apps/app
          zip -r ../../study-github-agent-app-v${{ github.run_number }}.zip dist/

      - name: Vitestãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®åœ§ç¸®
        run: |
          cd apps/app
          zip -r ../../vitest-report-v${{ github.run_number }}.zip test-results/

      - name: Playwrightãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®åœ§ç¸®
        run: |
          cd apps/app
          zip -r ../../playwright-report-v${{ github.run_number }}.zip playwright-report/

      - name: ãƒãƒ³ãƒ‰ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®åœ§ç¸®
        run: |
          cd apps/app
          zip ../../bundle-analysis-report-v${{ github.run_number }}.zip bundle-report.html

      - name: GitHub Pagesç”¨ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        run: |
          GITHUB_PAGES=true pnpm --filter app build
          touch apps/app/dist/.nojekyll

      - name: GitHub Pagesãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/app/dist

      - name: GitHub Release ã®ä½œæˆã¨ã‚¢ã‚»ãƒƒãƒˆæ·»ä»˜
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ github.run_number }}
          name: "Build ${{ github.run_number }}"
          artifacts: |
            study-github-agent-app-v${{ github.run_number }}.zip
            vitest-report-v${{ github.run_number }}.zip
            playwright-report-v${{ github.run_number }}.zip
            bundle-analysis-report-v${{ github.run_number }}.zip
          generateReleaseNotes: true
          body: |
            ## ğŸš€ Study GitHub Agent - Release Build ${{ github.run_number }}

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«ã¯ã€mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆï¼ˆ${{ github.sha }}ï¼‰ã«åŸºã¥ã„ãŸapps/appã®ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨å„ç¨®ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

            ### ğŸŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
            **ãƒªãƒªãƒ¼ã‚¹URL**: https://ao-39.github.io/study_github_agent/

            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯è‡ªå‹•çš„ã«GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸã€‚ä¸Šè¨˜URLã§æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚

            ### ğŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            - **study-github-agent-app-v${{ github.run_number }}.zip**: apps/appã®Vite + Reactãƒ“ãƒ«ãƒ‰æˆæœç‰©
              - index.html
              - CSSã€JavaScriptãƒ•ã‚¡ã‚¤ãƒ«
              - é™çš„ã‚¢ã‚»ãƒƒãƒˆ
            - **vitest-report-v${{ github.run_number }}.zip**: Vitestãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆ
              - ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã€ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã€å®Ÿè¡Œæ™‚é–“è©³ç´°
            - **playwright-report-v${{ github.run_number }}.zip**: Playwright E2Eãƒ†ã‚¹ãƒˆã®è©³ç´°HTMLãƒ¬ãƒãƒ¼ãƒˆ
              - E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã€å„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèªçµæœ
            - **bundle-analysis-report-v${{ github.run_number }}.zip**: JavaScriptãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æãƒ¬ãƒãƒ¼ãƒˆ
              - rollup-plugin-visualizerã«ã‚ˆã‚‹è©³ç´°ãªã‚µã‚¤ã‚ºåˆ†æã¨ãƒ„ãƒªãƒ¼ãƒãƒƒãƒ—è¡¨ç¤º

            ### ğŸ“‹ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è¨˜ã®ã€ŒAssetsã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹
            3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: Webã‚µãƒ¼ãƒãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦å…¬é–‹
            4. **ãƒ¬ãƒãƒ¼ãƒˆ**: HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦è©³ç´°ã‚’ç¢ºèª

            ### ğŸ”— é–¢é€£æƒ…å ±
            - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **ãƒ–ãƒ©ãƒ³ãƒ**: main
            - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: ${{ github.run_started_at }}

            ---
            *ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*

  # GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    name: GitHub Pagesãƒ‡ãƒ—ãƒ­ã‚¤
    needs: release
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      pages: write
      id-token: write
    steps:
      - name: GitHub Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: actions/deploy-pages@v4