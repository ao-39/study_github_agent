name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# GitHub Pagesへのデプロイに必要な権限を設定
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

# 同時実行の制御（メインブランチのデプロイを優先）
concurrency:
  group: "pages-${{ github.ref }}"
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # ビルドジョブ
  build:
    name: GitHub Pages用ビルド
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v4

      - name: Node.jsのセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: pnpmのセットアップ
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: pnpmストアディレクトリの取得
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: pnpmキャッシュの設定
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Turborepoキャッシュの設定
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: 依存関係のインストール
        run: pnpm install

      - name: GitHub Pages用ビルド実行
        run: GITHUB_PAGES=true pnpm --filter app build

      - name: GitHub Pagesの設定
        uses: actions/configure-pages@v5

      - name: ビルド成果物のアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/app/dist

  # メインブランチの場合のみデプロイ
  deploy:
    name: GitHub Pagesへのデプロイ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: GitHub Pagesへのデプロイ
        id: deployment
        uses: actions/deploy-pages@v4

  # PRの場合はプレビューURLコメントを追加
  preview-comment:
    name: プレビューURLコメント
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: PRにプレビューURLをコメント
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 🌐 GitHub Pagesデプロイメント

            PR #${{ github.event.pull_request.number }} のGitHub Pagesビルドが完了しました！

            ### 📱 プレビューについて
            **注意**: このPRはプレビューのみビルドされます。実際のデプロイはメインブランチにマージ後に実行されます。

            ### 🚀 本番デプロイメント
            **本番URL**: https://ao-39.github.io/study_github_agent/

            メインブランチにマージされると、上記URLで最新のアプリケーションが公開されます。

            ### 📦 ビルド成果物
            このPRのビルド成果物は [GitHub Actionsの実行ページ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) の「Artifacts」セクションからダウンロードできます。

            ### ⚙️ ビルド設定
            - **ベースパス**: `/study_github_agent/`（GitHub Pages用）
            - **ビルドツール**: Vite
            - **フレームワーク**: React + TypeScript

            ---
            *このコメントは自動で生成されました。メインブランチにマージすると本番環境にデプロイされます。*