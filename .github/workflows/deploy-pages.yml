name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:

permissions:
  pages: write
  id-token: write
  pull-requests: write

# 同時実行の制御（メインブランチのデプロイを優先）
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v4

      - name: Node.jsのセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: pnpmのセットアップ
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0

      - name: pnpmストアディレクトリの取得
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: pnpmキャッシュの設定
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Turborepoキャッシュの設定
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: 依存関係のインストール
        run: pnpm install

      - name: GitHub Pages用ビルド実行
        run: |
          GITHUB_PAGES=true pnpm --filter app build
          touch apps/app/dist/.nojekyll

      - name: ビルド成果物のアップロード
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/app/dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: github-pages
    if: github.ref == 'refs/heads/main'
    steps:
      - name: GitHub Pagesへのデプロイ
        uses: actions/deploy-pages@v4

  # PRの場合はビルド確認コメントを追加
  preview-comment:
    name: ビルド確認コメント
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    steps:
      - name: PRにビルド確認をコメント
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ✅ GitHub Pagesビルド完了

            PR #${{ github.event.pull_request.number }} のGitHub Pagesビルドが完了しました！

            ### 📦 ビルド成果物
            このPRのビルド成果物は [GitHub Actionsの実行ページ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) の「Artifacts」セクションからダウンロードできます。

            ### 🚀 デプロイメントについて
            **本番URL**: https://ao-39.github.io/study_github_agent/

            メインブランチにマージされると、上記URLで最新のアプリケーションが自動デプロイされます。

            ### ⚙️ ビルド設定
            - **ベースパス**: `/study_github_agent/`
            - **ビルドツール**: Vite
            - **フレームワーク**: React + TypeScript
            - **SPA対応**: .nojekyll ファイル追加済み

            ---
            *このコメントは自動で生成されました。*